{
    "sourceFile": "frontend/src/pages/campaigns/RecipientPreview.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1767980354297,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1767980354297,
            "name": "Commit-0",
            "content": "import React, { useState, useEffect } from 'react';\r\nimport { useParams, useNavigate } from 'react-router-dom';\r\nimport { ArrowLeft, Download, Send, Users, CheckCircle } from 'lucide-react';\r\nimport {\r\n  Button,\r\n  Card,\r\n  Table,\r\n  Badge,\r\n  LoadingSpinner,\r\n  Modal,\r\n} from '../../components/ui';\r\nimport { useCampaignStore } from '../../store/campaignStore';\r\nimport { useUserStore } from '../../store/userStore';\r\nimport { usePreferenceStore } from '../../store/preferenceStore';\r\nimport { useAuthStore } from '../../store/authStore';\r\nimport type { User } from '../../types';\r\n\r\nexport const RecipientPreview: React.FC = () => {\r\n  const { campaignId } = useParams<{ campaignId: string }>();\r\n  const navigate = useNavigate();\r\n  const { campaigns, updateCampaign } = useCampaignStore();\r\n  const { users } = useUserStore();\r\n  const { preferences } = usePreferenceStore();\r\n  const { hasPermission } = useAuthStore();\r\n  const [eligibleUsers, setEligibleUsers] = useState<User[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [showConfirmModal, setShowConfirmModal] = useState(false);\r\n  const [isSending, setIsSending] = useState(false);\r\n\r\n  const campaign = campaigns.find((c) => c.campaign_id === campaignId);\r\n  const canSend = hasPermission('campaigns', 'send');\r\n  const canDownload = hasPermission('campaigns', 'download');\r\n\r\n  useEffect(() => {\r\n    if (!campaign) return;\r\n\r\n    // Calculate eligible users\r\n    setTimeout(() => {\r\n      const eligible = users.filter((user) => {\r\n        // Must be active\r\n        if (!user.is_active) return false;\r\n\r\n        // Must have opted in for the notification type\r\n        const userPref = preferences[user.user_id];\r\n        if (!userPref) return false;\r\n\r\n        const notifType = campaign.notification_type;\r\n        if (!userPref[notifType]) return false;\r\n\r\n        // Must match city filter if specified\r\n        if (campaign.city_filter && user.city !== campaign.city_filter) {\r\n          return false;\r\n        }\r\n\r\n        return true;\r\n      });\r\n\r\n      setEligibleUsers(eligible);\r\n      setIsLoading(false);\r\n    }, 800);\r\n  }, [campaign, users, preferences]);\r\n\r\n  const handleDownloadCSV = () => {\r\n    const csvContent = [\r\n      'User ID,Name,Email,Phone,City',\r\n      ...eligibleUsers.map((user) =>\r\n        [user.user_id, user.name, user.email, user.phone || '', user.city || ''].join(',')\r\n      ),\r\n    ].join('\\n');\r\n\r\n    const blob = new Blob([csvContent], { type: 'text/csv' });\r\n    const url = window.URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.href = url;\r\n    a.download = `campaign-${campaignId}-recipients.csv`;\r\n    a.click();\r\n  };\r\n\r\n  const handleSend = async () => {\r\n    setIsSending(true);\r\n\r\n    // Mock sending process\r\n    await new Promise((resolve) => setTimeout(resolve, 2000));\r\n\r\n    // Update campaign status\r\n    updateCampaign(campaignId!, {\r\n      status: 'sent',\r\n      recipient_count: eligibleUsers.length,\r\n    });\r\n\r\n    setIsSending(false);\r\n    setShowConfirmModal(false);\r\n    navigate('/campaigns');\r\n  };\r\n\r\n  if (!campaign) {\r\n    return (\r\n      <div className=\"text-center py-12\">\r\n        <p className=\"text-gray-600\">Campaign not found</p>\r\n        <Button\r\n          onClick={() => navigate('/campaigns')}\r\n          variant=\"primary\"\r\n          className=\"mt-4\"\r\n        >\r\n          Back to Campaigns\r\n        </Button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-96\">\r\n        <LoadingSpinner size=\"lg\" text=\"Calculating eligible recipients...\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const columns = [\r\n    {\r\n      key: 'user_id',\r\n      header: 'User ID',\r\n      render: (user: User) => (\r\n        <span className=\"font-mono text-sm text-gray-600\">{user.user_id}</span>\r\n      ),\r\n    },\r\n    {\r\n      key: 'name',\r\n      header: 'Name',\r\n      render: (user: User) => (\r\n        <div>\r\n          <div className=\"font-medium text-gray-900\">{user.name}</div>\r\n          <div className=\"text-sm text-gray-500\">{user.email}</div>\r\n        </div>\r\n      ),\r\n    },\r\n    {\r\n      key: 'phone',\r\n      header: 'Phone',\r\n      render: (user: User) => <span className=\"text-gray-600\">{user.phone || '-'}</span>,\r\n    },\r\n    {\r\n      key: 'city',\r\n      header: 'City',\r\n      render: (user: User) => <span className=\"text-gray-600\">{user.city || '-'}</span>,\r\n    },\r\n    {\r\n      key: 'status',\r\n      header: 'Status',\r\n      render: () => <Badge variant=\"success\">Eligible</Badge>,\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div>\r\n        <Button\r\n          variant=\"outline\"\r\n          icon={<ArrowLeft className=\"w-5 h-5\" />}\r\n          onClick={() => navigate('/campaigns')}\r\n          size=\"sm\"\r\n        >\r\n          Back to Campaigns\r\n        </Button>\r\n        <h1 className=\"text-3xl font-bold text-gray-900 mt-4\">Recipient Preview</h1>\r\n        <p className=\"text-gray-600 mt-1\">{campaign.campaign_name}</p>\r\n      </div>\r\n\r\n      {/* Campaign Info */}\r\n      <Card>\r\n        <div className=\"p-6\">\r\n          <h3 className=\"font-semibold text-gray-900 mb-4\">Targeting Logic</h3>\r\n          <div className=\"space-y-2\">\r\n            <div className=\"flex items-center gap-2 text-sm\">\r\n              <CheckCircle className=\"w-4 h-4 text-green-600\" />\r\n              <span className=\"text-gray-700\">User must be active</span>\r\n            </div>\r\n            <div className=\"flex items-center gap-2 text-sm\">\r\n              <CheckCircle className=\"w-4 h-4 text-green-600\" />\r\n              <span className=\"text-gray-700\">\r\n                User must have opted in for{' '}\r\n                <strong>{campaign.notification_type.replace('_', ' ')}</strong>\r\n              </span>\r\n            </div>\r\n            {campaign.city_filter && (\r\n              <div className=\"flex items-center gap-2 text-sm\">\r\n                <CheckCircle className=\"w-4 h-4 text-green-600\" />\r\n                <span className=\"text-gray-700\">\r\n                  User must be from <strong>{campaign.city_filter}</strong>\r\n                </span>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </Card>\r\n\r\n      {/* Stats */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n        <Card className=\"p-6 bg-gradient-to-br from-primary-50 to-white\">\r\n          <div className=\"flex items-center gap-3 mb-2\">\r\n            <Users className=\"w-6 h-6 text-primary-600\" />\r\n            <h3 className=\"font-semibold text-gray-900\">Eligible Recipients</h3>\r\n          </div>\r\n          <div className=\"text-4xl font-bold text-primary-600\">\r\n            {eligibleUsers.length}\r\n          </div>\r\n        </Card>\r\n\r\n        <Card className=\"p-6 bg-gradient-to-br from-green-50 to-white\">\r\n          <div className=\"flex items-center gap-3 mb-2\">\r\n            <CheckCircle className=\"w-6 h-6 text-green-600\" />\r\n            <h3 className=\"font-semibold text-gray-900\">Ready to Send</h3>\r\n          </div>\r\n          <div className=\"text-4xl font-bold text-green-600\">\r\n            {eligibleUsers.length}\r\n          </div>\r\n        </Card>\r\n\r\n        <Card className=\"p-6\">\r\n          <div className=\"space-y-3\">\r\n            {canDownload && (\r\n              <Button\r\n                variant=\"outline\"\r\n                onClick={handleDownloadCSV}\r\n                icon={<Download className=\"w-5 h-5\" />}\r\n                className=\"w-full\"\r\n              >\r\n                Download CSV\r\n              </Button>\r\n            )}\r\n            {canSend && campaign.status === 'draft' && (\r\n              <Button\r\n                variant=\"success\"\r\n                onClick={() => setShowConfirmModal(true)}\r\n                icon={<Send className=\"w-5 h-5\" />}\r\n                className=\"w-full\"\r\n                disabled={eligibleUsers.length === 0}\r\n              >\r\n                Confirm & Send\r\n              </Button>\r\n            )}\r\n          </div>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Recipients Table */}\r\n      <Card title={`Recipients (${eligibleUsers.length})`}>\r\n        <Table\r\n          data={eligibleUsers}\r\n          columns={columns}\r\n          emptyMessage=\"No eligible recipients found\"\r\n        />\r\n      </Card>\r\n\r\n      {/* Confirmation Modal */}\r\n      <Modal\r\n        isOpen={showConfirmModal}\r\n        onClose={() => setShowConfirmModal(false)}\r\n        title=\"Confirm Send Campaign\"\r\n        footer={\r\n          <>\r\n            <Button variant=\"outline\" onClick={() => setShowConfirmModal(false)}>\r\n              Cancel\r\n            </Button>\r\n            <Button\r\n              variant=\"success\"\r\n              onClick={handleSend}\r\n              isLoading={isSending}\r\n              icon={<Send className=\"w-5 h-5\" />}\r\n            >\r\n              Send to {eligibleUsers.length} Users\r\n            </Button>\r\n          </>\r\n        }\r\n      >\r\n        <div className=\"space-y-4\">\r\n          <p className=\"text-gray-700\">\r\n            You are about to send <strong>{campaign.campaign_name}</strong> to{' '}\r\n            <strong>{eligibleUsers.length} users</strong>.\r\n          </p>\r\n          <div className=\"p-4 bg-yellow-50 border border-yellow-200 rounded-lg\">\r\n            <p className=\"text-sm text-yellow-800\">\r\n              <strong>Note:</strong> This action cannot be undone. Make sure you have reviewed\r\n              the recipient list carefully.\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </Modal>\r\n    </div>\r\n  );\r\n};\r\n"
        }
    ]
}